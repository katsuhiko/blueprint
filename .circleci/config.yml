version: 2
jobs:
  build:
    working_directory: ~/pm-api.blueprint
    machine: true
    steps:
      - checkout
      - run:
          name: AGLIO INSTALL
          command: npm install -g aglio
      - run:
          name: create dir
          command: mkdir blueprint.tmp
      - run:
          name: create html
          command: echo '# test' > blueprint.tmp/index.html
      - run:
          name: create blueprint
          command: aglio -- -i Blueprint/spec/index.apib -o blueprint.tmp/index2.html --theme-variables streak --theme-template triple
      - save_cache:
          key: blueprint-{{ epoch }}
          paths:
            - ~/pm-api.blueprint/blueprint.tmp

  deploy:
    working_directory: ~/pm-api.blueprint
    machine: true
    steps:
      - restore_cache:
          keys:
            - blueprint

      - run:
          name: deploy
          command: aws s3 sync ~/pm-api.blueprint/blueprint.tmp s3://nagashima-blueprint/

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build 
          filters:
            branches:
              only: master

